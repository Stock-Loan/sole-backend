from pathlib import Path
import pytest
from fastapi import UploadFile
from app.services.local_uploads import save_upload


@pytest.mark.asyncio
async def test_save_upload_allows_malicious_extensions(tmp_path):
    # Setup
    base_dir = tmp_path
    subdir = Path("uploads")

    # Create a dummy "malicious" file
    content = b"<html><script>alert(1)</script></html>"
    filename = "exploit.html"

    # Mock UploadFile
    from io import BytesIO

    file = UploadFile(file=BytesIO(content), filename=filename)

    # Execute save_upload
    try:
        await save_upload(file, base_dir, subdir, allowed_extensions={".pdf", ".png"})
        assert False, "Should have raised ValueError"
    except ValueError as e:
        assert "File type not allowed" in str(e)


@pytest.mark.asyncio
async def test_save_upload_allows_valid_extensions(tmp_path):
    # Setup
    base_dir = tmp_path
    subdir = Path("uploads")

    # Create a valid PDF file
    content = b"%PDF-1.4..."
    filename = "document.pdf"

    # Mock UploadFile
    from io import BytesIO

    file = UploadFile(file=BytesIO(content), filename=filename)

    # Execute save_upload with allowed extensions
    relative_path, original_name = await save_upload(
        file, base_dir, subdir, allowed_extensions={".pdf", ".png"}
    )

    # Verify the file was saved
    assert original_name == filename
    assert relative_path.endswith(".pdf")

    saved_file = base_dir / relative_path
    assert saved_file.exists()
    assert saved_file.read_bytes() == content
